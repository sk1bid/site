name: Deploy DevOps Site to K3s

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      # ğŸ§© 1. Ğ—Ğ°Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ĞºĞ¾Ğ´
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸª£ 2. Ğ›Ğ¾Ğ³Ğ¸Ğ½Ğ¸Ğ¼ÑÑ Ğ² GHCR
      - name: Log in to GHCR
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # ğŸ› ï¸ 3. Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸ Ğ¿ÑƒÑˆĞ¸Ğ¼ Docker-Ğ¾Ğ±Ñ€Ğ°Ğ·
      - name: Build and push Docker image
        env:
          REPO: ghcr.io/${{ github.repository }}
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          if [ "${{ github.ref_name }}" = "main" ]; then
            TAG="prod-$SHORT_SHA"
          else
            TAG="dev-$SHORT_SHA"
          fi

          echo "ğŸ”¨ Building image: $REPO:$TAG"
          docker build -t $REPO:$TAG .

          echo "ğŸ“¦ Pushing image to GHCR..."
          docker push $REPO:$TAG

          # ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚ĞµĞ³ Ğ´Ğ»Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
          echo "TAG=$TAG" >> $GITHUB_ENV

      # ğŸš€ 4. Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° Ğ´Ğ¾Ğ¼Ğ°ÑˆĞ½Ğ¸Ğ¹ K3s Ñ‡ĞµÑ€ĞµĞ· SSH
      - name: Deploy to K3s over SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            REPO="ghcr.io/${{ github.repository }}"
            TAG=${{ env.TAG }}

            echo "ğŸŒ€ Deploying image $REPO:$TAG to K3s..."

            # namespace Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ, ĞµÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ ÑĞ²Ğ¾Ğ¹
            NAMESPACE="default"

            # ĞµÑĞ»Ğ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ â€” Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ·
            if kubectl get deploy devops-site -n $NAMESPACE >/dev/null 2>&1; then
              echo "ğŸ” Updating existing deployment..."
              kubectl set image deploy/devops-site devops-site=$REPO:$TAG -n $NAMESPACE
              kubectl rollout restart deploy/devops-site -n $NAMESPACE
            else
              echo "ğŸš€ Creating new deployment..."
              kubectl create deployment devops-site --image=$REPO:$TAG -n $NAMESPACE
              kubectl expose deployment devops-site --port=80 --target-port=8080 --name=devops-site -n $NAMESPACE
            fi

            # Ğ¶Ğ´Ñ‘Ğ¼ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
            kubectl rollout status deploy/devops-site -n $NAMESPACE

            echo "ğŸ‰ Deployment complete!"
